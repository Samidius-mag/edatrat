# Исправление ошибки 502 Bad Gateway

## Проблема
Nginx не может подключиться к приложению на портах 27015 (frontend) или 3001 (backend).

## Быстрая диагностика

Выполните на сервере:

```bash
# 1. Проверьте, запущено ли приложение
ps aux | grep -E 'node|vite|npm'

# 2. Проверьте, слушают ли порты
sudo netstat -tlnp | grep -E '27015|3001'
# Или
sudo ss -tlnp | grep -E '27015|3001'

# 3. Проверьте доступность локально
curl http://localhost:27015
curl http://localhost:3001/api/health

# 4. Проверьте логи Nginx
sudo tail -20 /var/log/nginx/edatrat-error.log
```

## Решение

### Вариант 1: Приложение не запущено

```bash
# Запустите приложение
cd ~/edatrat
npm run dev

# Или через Docker
docker compose up -d
```

### Вариант 2: Приложение слушает только на 127.0.0.1

Убедитесь, что:
- Frontend в `vite.config.js` имеет `host: '0.0.0.0'` ✅ (уже настроено)
- Backend слушает на всех интерфейсах ✅ (исправлено)

### Вариант 3: Проверьте конфигурацию Nginx

```bash
# Проверьте синтаксис
sudo nginx -t

# Проверьте, что конфигурация активна
ls -la /etc/nginx/sites-enabled/

# Если нужно, перезагрузите Nginx
sudo systemctl reload nginx
```

### Вариант 4: Проверьте файрвол

```bash
# Проверьте статус
sudo ufw status

# Если нужно, разрешите локальные подключения
# (обычно не требуется, так как это localhost)
```

## Пошаговая проверка

1. **Запустите приложение:**
   ```bash
   cd ~/edatrat
   npm run dev
   ```

2. **В другом терминале проверьте порты:**
   ```bash
   sudo netstat -tlnp | grep -E '27015|3001'
   ```
   Должны увидеть:
   ```
   tcp  0  0  0.0.0.0:27015  LISTEN  node
   tcp  0  0  0.0.0.0:3001    LISTEN  node
   ```

3. **Проверьте доступность:**
   ```bash
   curl http://localhost:27015
   curl http://localhost:3001/api/health
   ```

4. **Проверьте логи Nginx:**
   ```bash
   sudo tail -f /var/log/nginx/edatrat-error.log
   ```

5. **Если все работает локально, но не через Nginx:**
   ```bash
   # Проверьте конфигурацию Nginx
   sudo nginx -t
   
   # Перезагрузите Nginx
   sudo systemctl reload nginx
   ```

## Частые ошибки в логах

### "Connection refused"
- Приложение не запущено
- Решение: запустите `npm run dev`

### "Connection timeout"
- Приложение не отвечает
- Решение: проверьте, что приложение действительно работает

### "No route to host"
- Проблемы с сетью
- Решение: проверьте файрвол и сетевые настройки

## После исправления

После того как приложение запущено и работает локально:

1. Проверьте в браузере: `https://vgk-perv.ru`
2. Должен открыться фронтенд без ошибок 502
3. API должен работать: `https://vgk-perv.ru/api/health`

## Автозапуск при перезагрузке сервера

Чтобы приложение запускалось автоматически, настройте systemd service или используйте PM2:

```bash
# Установка PM2
npm install -g pm2

# Запуск через PM2
cd ~/edatrat
pm2 start npm --name "edatrat" -- run dev

# Сохранение конфигурации
pm2 save
pm2 startup
```

